#!/usr/bin/env php
<?php

foreach ([__DIR__ . '/../../autoload.php', __DIR__ . '/../vendor/autoload.php', __DIR__ . '/vendor/autoload.php'] as $file) {
    if (file_exists($file)) {
        require $file;
        break;
    }
}

$files = \Symfony\Component\Finder\Finder::create()
    ->in(__DIR__ . '/../src')
    ->name("composer.json")
    ->files();

$require = [];
$requireDev = [];
$configProviders = [];
foreach ($files as $file) {
    $component = basename(dirname($file));
    $composerJson = json_decode(file_get_contents($file), true);

    foreach (isset($composerJson['autoload']['psr-4']) ? $composerJson['autoload']['psr-4'] : [] as $ns => $dir) {
        $require[$ns] = "src/$component/" . trim($dir, '/').'/';
    }
    foreach (isset($composerJson['autoload-dev']['psr-4']) ? $composerJson['autoload-dev']['psr-4'] : [] as $ns => $dir) {
        $requireDev[$ns] = "src/$component/" . trim($dir, '/').'/';
    }
    if (isset($composerJson['extra']['hyperf']['config'])) {
        $configProviders = array_merge($configProviders, (array)$composerJson['extra']['hyperf']['config']);
    }
}
ksort($require);
ksort($requireDev);
sort($configProviders);
$json = json_decode(file_get_contents(__DIR__ . '/../composer.json'));
$json->autoload->{'psr-4'} = $require;
$json->{'autoload-dev'}->{'psr-4'} = $requireDev;
$json->extra->hyperf->config = $configProviders;
file_put_contents(__DIR__ . '/../composer.json',
    json_encode($json, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT));
